import streamlit as st
from transformers import pipeline, AutoTokenizer, AutoModelForSeq2SeqLM
import torch
from PIL import Image
from io import BytesIO

st.set_page_config(page_title="üé® –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (—Ä—É—Å—Å–∫–∏–π)", layout="centered")
st.title("üé® –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é")
st.caption("–ü–∏—à–∏—Ç–µ –Ω–∞ —Ä—É—Å—Å–∫–æ–º ‚Äî —Å–∏—Å—Ç–µ–º–∞ –ø–µ—Ä–µ–≤–µ–¥—ë—Ç –∏ —Å–æ–∑–¥–∞—Å—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ!")

@st.cache_resource
def load_translation_pipeline():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –º–æ–¥–µ–ª—å –ø–µ—Ä–µ–≤–æ–¥–∞: —Ä—É—Å—Å–∫–∏–π ‚Üí –∞–Ω–≥–ª–∏–π—Å–∫–∏–π"""
    model_name = "Helsinki-NLP/opus-mt-ru-en"
    tokenizer = AutoTokenizer.from_pretrained(model_name)
    model = AutoModelForSeq2SeqLM.from_pretrained(model_name)
    translator = pipeline("translation", model=model, tokenizer=tokenizer, device=0 if torch.cuda.is_available() else -1)
    return translator

@st.cache_resource
def load_image_generator():
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –º–æ–¥–µ–ª—å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π"""
    device = 0 if torch.cuda.is_available() else -1
    generator = pipeline(
        "text-to-image",
        model="runwayml/stable-diffusion-v1-5",
        torch_dtype=torch.float16 if torch.cuda.is_available() else torch.float32,
        device=device
    )
    return generator

try:
    translator = load_translation_pipeline()
    image_gen = load_image_generator()
except Exception as e:
    st.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏: {e}")
    st.stop()

user_prompt_ru = st.text_input("üí¨ –û–ø–∏—à–∏—Ç–µ, —á—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —É–≤–∏–¥–µ—Ç—å (–Ω–∞ —Ä—É—Å—Å–∫–æ–º):", "–ö–æ—Ç –≤ –∫–æ—Å–º–æ—Å–µ, —Ü–∏—Ñ—Ä–æ–≤–æ–µ –∏—Å–∫—É—Å—Å—Ç–≤–æ")

if st.button("üöÄ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"):
    if not user_prompt_ru.strip():
        st.warning("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ.")
    else:
        with st.spinner("–ü–µ—Ä–µ–≤–æ–¥–∏–º –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π..."):
            # –ü–µ—Ä–µ–≤–æ–¥ —Å —Ä—É—Å—Å–∫–æ–≥–æ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π
            translation = translator(user_prompt_ru, max_length=64)
            prompt_en = translation[0]['translation_text']
        
        st.info(f"–ü–µ—Ä–µ–≤–µ–¥–µ–Ω–æ: _{prompt_en}_")
        
        with st.spinner("–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è... (—ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 30‚Äì90 —Å–µ–∫ –Ω–∞ CPU)"):
            try:
                # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                result = image_gen(prompt_en, num_inference_steps=25)
                image: Image.Image = result[0]["generated_image"]
                
                # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                st.image(image, caption=f"–ó–∞–ø—Ä–æ—Å: {user_prompt_ru}", use_column_width=True)
                
                # –ö–Ω–æ–ø–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                buf = BytesIO()
                image.save(buf, format="PNG")
                st.download_button(
                    label="üíæ –°–∫–∞—á–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ",
                    data=buf.getvalue(),
                    file_name="generated_image.png",
                    mime="image/png"
                )
            except Exception as e:
                st.error(f"–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: {e}")
