import streamlit as st
from transformers import T5Tokenizer, T5ForConditionalGeneration
import torch

@st.cache_resource
def load_ru_summarizer():
    model_name = "IlyaGusev/ru_t5_base_summarizer"
    tokenizer = T5Tokenizer.from_pretrained(model_name)
    model = T5ForConditionalGeneration.from_pretrained(model_name)
    return tokenizer, model

tokenizer, model = load_ru_summarizer()

def summarize_russian(text):
    # –ú–æ–¥–µ–ª—å –æ–∂–∏–¥–∞–µ—Ç –ø—Ä–µ—Ñ–∏–∫—Å "summarize: ", –Ω–æ –¥–ª—è —Ä—É—Å—Å–∫–æ–π –≤–µ—Ä—Å–∏–∏ –æ–Ω –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
    inputs = tokenizer(
        text,
        return_tensors="pt",
        max_length=1024,
        truncation=True,
        padding="max_length"
    )
    summary_ids = model.generate(
        inputs.input_ids,
        max_length=256,
        min_length=30,
        length_penalty=1.2,
        num_beams=4,
        early_stopping=True
    )
    return tokenizer.decode(summary_ids[0], skip_special_tokens=True)

st.set_page_config(page_title="‚úÇÔ∏è –°—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º", layout="centered")
st.title("‚úÇÔ∏è –°—É–º–º–∞—Ä–∏–∑–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ")
st.caption("–í–≤–µ–¥–∏—Ç–µ –ª—é–±–æ–π —Ä—É—Å—Å–∫–∏–π —Ç–µ–∫—Å—Ç ‚Äî –º–æ–¥–µ–ª—å —Å–æ–∑–¥–∞—Å—Ç –∫—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ.")

input_text = st.text_area(
    "üìù –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º:",
    "–ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç ‚Äî —ç—Ç–æ –æ–±–ª–∞—Å—Ç—å –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã—Ö –Ω–∞—É–∫, –∫–æ—Ç–æ—Ä–∞—è –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è —Å–æ–∑–¥–∞–Ω–∏–µ–º —Å–∏—Å—Ç–µ–º, —Å–ø–æ—Å–æ–±–Ω—ã—Ö –≤—ã–ø–æ–ª–Ω—è—Ç—å –∑–∞–¥–∞—á–∏, —Ç—Ä–µ–±—É—é—â–∏–µ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–≥–æ –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞. –ö —Ç–∞–∫–∏–º –∑–∞–¥–∞—á–∞–º –æ—Ç–Ω–æ—Å—è—Ç—Å—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ä–µ—á–∏, –ø—Ä–∏–Ω—è—Ç–∏–µ —Ä–µ—à–µ–Ω–∏–π, –æ–±—É—á–µ–Ω–∏–µ –∏ –ø–æ–Ω–∏–º–∞–Ω–∏–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞. –í –ø–æ—Å–ª–µ–¥–Ω–∏–µ –≥–æ–¥—ã –ò–ò –¥–æ–±–∏–ª—Å—è –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –±–ª–∞–≥–æ–¥–∞—Ä—è —Ä–∞–∑–≤–∏—Ç–∏—é –≥–ª—É–±–æ–∫–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è –∏ —É–≤–µ–ª–∏—á–µ–Ω–∏—é –≤—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω—ã—Ö –º–æ—â–Ω–æ—Å—Ç–µ–π."
)

if st.button("–°–æ–∑–¥–∞—Ç—å –∫—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ"):
    if input_text.strip():
        with st.spinner("–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏... (–ø–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 30‚Äì90 —Å–µ–∫—É–Ω–¥)"):
            summary = summarize_russian(input_text)
        st.subheader("‚úÖ –ö—Ä–∞—Ç–∫–æ–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ")
        st.write(summary)
    else:
        st.warning("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç.")
